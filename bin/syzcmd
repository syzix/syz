#!/bin/bash
# FIXME: use #!/shbang bash

# Copyright (C) 2012 Kevin Pulo.
#
# This file is part of syz.
# 
# syz is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# syz is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with syz.  If not, see <http://www.gnu.org/licenses/>.

. shwrapnel || { echo "shwrapnel: Error: cannot source shwrapnel" 1>&2 ; exit 1; }

shwrapnel set_real_cmd modulecmd

if [ "$2" = "basedir" ]; then
	shwrapnel run "$1" show "$3" 2>&1 | sed -ne 's,^setenv\s\+[A-Za-z0-9_]\+_BASE\s\+,echo ,p'

elif [ "$2" = "cd" ]; then
	if [ $# -eq 2 ]; then
		# The user has done "syz cd", probably absent-mindedly trying to get back to their home dir.
		echo "cd"
		exit 0
	fi
	if [ "$3" = - ]; then
		# Another likely brainfart.
		echo "cd -"
		exit 0
	fi

	basedir="$(syz basedir "$3")"
	if [ "$basedir" = "" ]; then
		echo "syzcmd: Error: \"$3\" not found" 1>&2
		exit 1
	fi
	if [ $# -eq 4 ]; then
		basedir="$basedir/$4"
		if [ ! -d "$basedir" ]; then
			if [ ! -e "$basedir" ]; then
				echo "syzcmd: Error: \"$basedir\" not found" 1>&2
				exit 1
			else
				echo "syzcmd: Error: \"$basedir\" not a directory" 1>&2
				exit 1
			fi
		fi
	fi
	echo "cd $basedir"

else
	shwrapnel launch

fi

